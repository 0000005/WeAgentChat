# Epic 08: 消息气泡交互与快捷操作增强

## Epic 信息
- **Epic 编号**: Epic-08
- **Epic 名称**: 消息气泡交互与快捷操作增强
- **创建日期**: 2026-01-19
- **优先级**: Medium

## 业务目标

本 Epic 旨在通过增强聊天气泡的交互能力，提升用户对会话的控制力和透明度。
1. **提升操作效率**：让用户能快速复制内容或纠正错误（撤回）。
2. **增强 AI 可解释性**：允许用户查看 AI 的思考过程和工具调用细节，建立对 AI 的信任。
3. **优化会话体验**：提供“重新回答”功能，让用户能便捷地获取更好的 AI 回复。

## 范围描述

### 包含内容
- **气泡 Hover 交互**：鼠标悬停在消息气泡上时显示“...”更多操作按钮。
- **操作菜单**：点击“...”按钮唤起下拉菜单，菜单项根据消息类型和属性动态展示。
- **好友（AI）消息操作**：
  - **多气泡消息识别**：
    - 若 AI 的一次回复包含多个 `<message>` 标签（在 UI 上渲染为多个气泡），这些气泡被视为 **同一个逻辑消息**。
    - **Hover 触发区域**：每个气泡都可独立 Hover 并显示"..."按钮。
    - **操作范围**：
      - "**复制**"仅复制当前悬停气泡的内容。
      - "**重新回答**"、"**查看思考过程**"、"**查看工具调用**"针对整个逻辑消息（所有关联气泡）。
  - **复制**：复制当前气泡内容到剪贴板。
  - **重新回答**：
    - **业务规则**：删除整个逻辑消息（包括所有关联气泡），在原位置重新开始流式生成。
    - **范围**：针对整个 AI 回复的消息组。
  - **查看思考过程**：
    - **显示条件**：若该逻辑消息包含 `reasoning` 或 `thinking` 数据，则显示；否则隐藏菜单项。
    - **展示方式**：居中 Modal 弹窗，支持 Markdown 渲染。
  - **查看工具调用**：
    - **显示条件**：若该逻辑消息包含 `tool_calls` 数据，则显示；否则隐藏菜单项。
    - **展示方式**：居中 Modal 弹窗，展示函数名、参数和结果（支持 JSON 树状展示）。
- **用户（User）消息操作**：
  - **撤回**：
    - **业务规则**：仅当消息所属的会话（Session）处于 **未归档状态** 时允许撤回。已归档会话的历史消息禁止撤回。
    - **级联动作**：用户发起撤回时，系统将 **同时撤回（删除）该请求所对应的 AI 回复消息**。
    - **交互效果**：用户气泡替换为系统提示“你撤回了一条消息”，对应的好友回复气泡直接从 UI 移除。

### 不包含内容
- 消息的多选、转发、编辑（Edit）功能。
- 移动端的长按交互。

## 用户旅程

```
[场景 1：查看 AI 思考]
用户对 AI 的回复感到好奇 → 悬停消息点击“...” → 选择“查看思考过程” → 弹窗展示完整的推理链

[场景 2：消息撤回]
用户发现刚才发出的消息有误 → 悬停自己消息点击“...” → 选择“撤回” → 自己的气泡变为“你撤回了一条消息”，同时 AI 刚才生成的回复也随之消失。

[场景 3：快速复制]
用户想引用某段话 → 悬停并点击“...” → 选择“复制” → 成功将文本写入系统剪贴板

[场景 4：生成不满重试]
用户觉得当前回复不佳 → 悬停消息点击“...” → 选择“重新回答” → 原位置开始伴随流式动画生成新答案

[场景 5：排查工具异常]
AI 查询失败 → 用户悬停消息点击“...” → 选择“查看工具调用” → 弹窗核实具体调用的 API 参数和回复
```

## Story 拆分建议

| Story | 描述 | 优先级 |
|-------|------|--------|
| Story 08-01 | 消息气泡 Hover 交互及动态 Dropdown 菜单实现 | High |
| Story 08-02 | 文本复制逻辑与剪贴板集成 | High |
| Story 08-03 | 用户消息“撤回”功能及会话状态校验逻辑 | High |
| Story 08-04 | AI 消息“重新回答”逻辑（清空旧回复并重新触发流式） | Medium |
| Story 08-05 | “思考过程”展示弹窗与渲染组件实现 | Medium |
| Story 08-06 | “工具调用”详情展示组件（JSON 解析与预览） | Low |

## 技术约束与依赖

### 前置依赖
- Epic-01: 基础聊天界面
- 后端 `chat` 接口支持接受 `action='regenerate'` 或类似逻辑

### 限制与已知问题
- **非持久化限制**：消息的 `reasoning`（思考过程）和 `tool_calls`（工具调用）**未保存**到数据库。
- **可见性条件**：功能入口仅在前端内存缓存有效时显示（即“最近”的消息）。一旦页面刷新并从数据库重新加载消息，相关详情将无法查看。
- **后续优化计划**：若有业务需求，可在后续 Epic 中考虑后端增加相应表字段实现持久化。

### 后续 Epic
- 无
