# Story 09-08: 隐藏的群管理员 Agent (Hidden Admin)

> Epic: AI 多人群聊 (Group Chat)
> Priority: High
> Points: 8

## 概述
实现群聊的"调度大脑"（群管理员 Agent）。当用户未显式 @ 成员时，由群管理员根据话题与角色相关性挑选发言者；当用户明确 @ 成员时，仅被 @ 的成员发言（多人则并行发言），群管理员完全跳过。若 @ 列表**全部无效或为空**（不存在/已移除），则降级为群管理员选人；若部分有效，则仅保留有效成员并发言，忽略无效项。群管理员每次至少选择 1 人、最多选择 3 人发言，并支持多发言者并行生成与前端单流 SSE 的异步呈现。

## 用户故事

### US-1: 自动角色分配
**作为** 用户，
**我希望** 在群里抛出一个特定话题（如"谁了解 Python？"）后，对应的专长 AI 能主动接话，
**以便** 获得像与真人社交一样的即时反应。

### US-2: 显式 @ 的唯一发言者
**作为** 用户，
**我希望** 当我明确 @ 某成员时，只有被 @ 的成员发言，
**以便** 精准对话，避免其它成员打断。

### US-3: 避免复读干扰
**作为** 系统，
**我希望** 在非必要时限制发言人数（每次 1~3 人），
**以便** 防止消息爆炸和资源浪费。

## 功能范围

### 包含
- **Manager Prompt 管理**: 系统提示词定义在 `server/app/prompt/chat/group_manager.txt`；few-shot 示例放在 `server/app/prompt/chat/few_shot/` 下，并通过模拟多轮对话注入（而非拼接到 system prompt）。
- **分发决策器**: 后端拦截用户群聊消息；当未显式 @ 时，调用群管理员生成发言者 ID 列表（1~3 人）。
- **显式 @ 处理**: 当用户明确 @ 成员时，仅被 @ 的成员发言（多人并行）；群管理员完全跳过，不追加其他发言者。若 @ 列表全部无效或为空，则降级为群管理员选人；若部分有效，则忽略无效项。
- **调度执行引擎**: 解析清单并并行拉起多个发言者的 LLM/回忆/生成链路。
- **SSE 单流多发言者**: 前端在单个 SSE 请求中接收多个发言者的流式输出，允许乱序展示并异步呈现各自消息。
- **决策阈值控制**: 强制限制单次最少 1 人、最多 3 人发言。
- **上下文输入约束**: chatHistory 截断上限为最近 20 条文本发言。

### 不包含（后续迭代）
- Agent 之间的主动"抢话"逻辑（目前仍由用户消息驱动）
- 管理员显式参与群管理（如禁言模仿、踢人等）

## 群管理员 Prompt 结构（示例）
> 仅为结构示例，具体内容以 `server/app/prompt/chat/group_manager.txt` 与 `server/app/prompt/chat/few_shot/` 为准。few-shot 通过模拟多轮对话注入，而非直接拼接到 system prompt。
> 约束：默认加载 5 个 few-shot 示例，按序号 1→5 顺序注入。

```
---system prompt---
你是一个群管理员，你负责从根据话题和人物的相关性选择下一个发言者。
最少选一个发言者，最多选择3个发言者。最后以json的方式返回发言者的id。

示例返回：
```json
[10,1]
```

---system prompt---


--- round 1 (few shot)---
User:
当前群成员列表：
{memberList}

当前聊的聊天记录
{chatHistory}

Assistant:
{json}
--- round 1 (few shot)---

--- round 2 (few shot)---
User:
当前群成员列表：
{memberList}

当前聊的聊天记录
{chatHistory}

Assistant:
{json}
--- round 2(few shot)---
```

## 验收标准

- [ ] AC-1: 当用户未显式 @ 成员时，群管理员返回 1~3 个发言者 ID。
- [ ] AC-2: 当用户明确 @ 成员时，仅被 @ 的成员发言（多人并行），群管理员完全跳过。
- [ ] AC-3: 当 @ 列表部分无效时，仅有效成员发言，且不触发群管理员。
- [ ] AC-4: 当 @ 列表全部无效或为空时，降级为群管理员选人（1~3 人）。
- [ ] AC-5: 选择多个发言者时，后端并行执行各发言者的 LLM/回忆/生成链路。
- [ ] AC-6: 前端在单个 SSE 流中可接收并异步展示多个发言者的消息，允许乱序；每个发言者都有 `done` 或 `error` 终止事件。
- [ ] AC-7: `group_manager.txt` 与 `few_shot/` 中的 5 个多轮 few-shot 被正确加载，且按序号 1→5 注入，非 system prompt 直塞方式。
- [ ] AC-8: chatHistory 截断为最近 20 条文本发言后送入群管理员。
- [ ] AC-9: 记录清晰的群管理员决策日志（包含输入上下文与输出 ID 列表）。

## 依赖关系

### 前置依赖
- Story 09-04: @提及功能与强制触发
- Story 09-06: 群聊上下文适配
- Story 09-07: GroupChatArea 并行渲染

### 被依赖（后续）
- 无
