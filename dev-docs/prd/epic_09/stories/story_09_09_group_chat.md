# Story 09-09: 群聊被动/手动新会话（无记忆归档）

> Epic: AI 多人群聊 (Group Chat)
> Priority: High
> Points: 5

## 概述
为群聊新增**被动新开会话**与**手动新建会话**功能。逻辑与单聊一致：超过指定空闲时间后自动结束当前会话并开启新会话；用户点击“新建会话”图标后立即结束当前会话并开启新会话。**唯一差异：群聊会话结束不触发任何记忆归档或 Memobase 调用**。

## 用户故事

### US-1: 被动新会话
**作为** 用户，
**我希望** 群聊在我长时间不说话后自动结束上一轮并进入新会话，
**以便** 对话有自然的时间分段。

### US-2: 手动新会话
**作为** 用户，
**我希望** 点击群聊里的“新建会话”图标即可结束上一轮并开始新会话，
**以便** 主动切换话题或阶段。

### US-3: 不生成群聊记忆
**作为** 系统，
**我希望** 群聊会话结束时不触发任何记忆归档，
**以便** 避免群聊内容进入长期记忆。

## 功能范围

### 包含
- **被动新会话（群聊）**：与单聊一致的空闲阈值与判定逻辑；达到阈值后自动结束上一轮并开启新会话。
- **手动新会话（群聊）**：用户点击群聊“新建会话”图标后，立即结束上一轮并开启新会话。
- **无记忆归档**：群聊会话结束不会生成事件卡片，不触发任何 Memobase 调用（提取/写入/向量化均不发生）。
- **会话状态一致性**：前端会话列表、当前会话 ID/时间戳等状态在结束与新建时与单聊保持一致的更新节奏与体验。

### 不包含（后续迭代）
- 群聊专属的记忆策略或例外白名单
- 群聊会话结束时的总结性系统消息

## 配置项（与单聊一致）

- **配置名**：`session.passive_timeout`（`system_settings` 表，`group_name=session`，`key=passive_timeout`）
- **单位**：秒
- **默认值**：`1800`（30 分钟）
- **说明**：单聊文档中对该阈值的产品命名为 **`SESSION_IDLE_THRESHOLD`**，实现层统一使用 `session.passive_timeout` 读取与保存。

## 技术实现建议（最佳实践）

- **会话生命周期复用，记忆归档分流**：群聊与单聊保持“数据模型/服务”分离，但抽取一个通用的“会话生命周期”模块（如 `session_lifecycle`），复用被动超时判定与手动新会话流程；通过 `on_session_end` 回调注入差异化逻辑。  
  - 单聊：`on_session_end` = 归档 + Memobase 调用  
  - 群聊：`on_session_end` = 空实现（不触发任何记忆链路）  
  优点：避免复制逻辑、降低耦合、清晰区分记忆策略。
- **前端会话分隔线参考单聊实现**：当前群聊页面仅插入“新会话”系统消息，**没有时间分隔线**。建议复用单聊 `ChatArea.vue` 的分隔线逻辑：  
  - `shouldShowSessionDivider`（session_id 变化时显示分隔线）  
  - `formatSessionTime`（微信样式时间文案）  
  - 渲染 `.session-divider` 与 `.divider-time` 的样式块  
  群聊可在 `GroupChatArea.vue` 中实现同等逻辑，或抽公共组件/工具函数，保持 UI 行为一致。

## 验收标准

- [ ] AC-1: 群聊在超过 `session.passive_timeout` 所定义的空闲阈值后自动结束当前会话并开启新会话。
- [ ] AC-2: 用户点击群聊“新建会话”图标后，立即结束当前会话并开启新会话。
- [ ] AC-3: 群聊会话结束时**不触发**任何 Memobase 调用（提取/写入/向量化均为 0 次）。
- [ ] AC-4: 群聊会话结束**不生成**事件卡片或长期记忆。
- [ ] AC-5: 被动/手动新会话的 UI 与交互节奏与单聊保持一致（除记忆归档差异外）。

## 依赖关系

### 前置依赖
- Story 09-05: 群聊会话与消息基础能力
- 单聊被动会话与手动新会话逻辑（同款逻辑复用）

### 被依赖（后续）
- 无
