# Story 12-4: 语音消息回复流程

> Epic: Epic 12: 语音消息能力
> Priority: High
> Points: 8

## 概述
本 Story 实现核心的语音消息生成与展示逻辑。当配置了语音回复的好友发送消息时，系统需要在后台并行进行语音合成，并在前端以仿微信的语音消息气泡展示，支持连续自动播放。

## 用户故事

### US-1: 接收语音回复
**作为** 用户，
**我希望** 收到开启了语音功能的好友回复时，能看到语音条和对应的文字，
**以便** 我可以选择听语音或看文字。

### US-2: 快速响应
**作为** 用户，
**我希望** 语音合成不会造成长时间的等待，
**以便** 保持聊天的流畅性。

### US-3: 连续播放体验
**作为** 用户，
**我希望** 点击一条语音播放且结束后，能自动播放下一条未读语音，
**以便** 我能像听微信语音一样连贯地听完一段长回复。

## 功能范围

### 包含
-   **后端流程 (Chat Service)**：
    -   判断当前发送消息的 Agent 是否开启了语音。
    -   LLM 生成回复文本（可能包含多个 `<message>` 标签分段）。
    -   **并行 TTS**：对每个 `<message>` 分段，并行调用阿里云 TTS 接口生成音频。
    -   **SSE 推送**：除了推送文本内容，需新增事件推送音频 URL（或在 message done 时携带音频信息）。
-   **前端 UI (ChatArea)**：
    -   组件更新：支持渲染语音消息气泡（Voice Bubble）。
    -   样式：仿微信设计，显示时长（秒），点击播放/暂停图标变化，未读红点。
    -   布局：语音条上方/下方显示识别出的/原始的文字内容（根据需求描述“上面是一个语音条，下面是对应的文字消息”）。
-   **播放逻辑**：
    -   点击播放。
    -   自动播放：当前语音播放结束 -> 检查下一条消息 -> 若是语音且未读 -> 自动播放 -> 标记为已读。
-   **群聊支持**：群聊中若某位发言群员开启了语音，其消息也应显示为语音。

### 不包含
-   语音转文字（ASR）：目前仅是 TTS（文字转语音），前端显示的文字是 LLM 原始生成的文本。
-   用户发送语音消息（输入端暂不支持录音）。

## 验收标准

- [ ] AC-1: AI 回复消息时，若开启语音，前端显示语音条组件。
- [ ] AC-2: 语音条下方正确显示原始文本内容。
- [ ] AC-3: 后端能够并行处理多个消息段的 TTS 请求，确保首条语音尽快返回。
- [ ] AC-4: 点击语音条，能够正常播放音频，图标状态切换（播放中/暂停）。
- [ ] AC-5: **连续播放**：点击播放一条未读语音，播放完毕后，自动开始播放下一条未读语音，直到遇到非语音或已读消息。
- [ ] AC-6: 语音消息具备“已读/未读”状态标识（如红点），播放后红点消失。

## 依赖关系

### 前置依赖
- Story 12-3: 好友语音个性化配置

## 备注
-   **性能优化**：TTS 建议使用 DashScope 的流式 API 或并行非流式调用。由于需要返回完整音频 URL 供前端播放（非实时流式播放 PCM），建议对长回复按句子或 `<message>` 标签切分后并行请求非流式接口，获取 MP3/WAV URL。若使用流式，需后端转码保存为文件。
-   **文件存储**：合成的音频文件需保存在 `server/static/audio` 或类似目录，定期清理策略需考虑（本 Story 暂不强制要求清理逻辑）。
