# User Story: 头像上传与图片剪切功能 (Avatar Upload & Image Cropping)

## 1. 背景与目标 (Background & Goals)
在 WeAgentChat 中，个性化是社交体验的核心。目前，用户资料和 AI 好友的头像大部分使用默认占位符或硬编码的 URL。
为了提升真实感和品牌美感，我们需要支持：
1. **用户头像自定义**：用户可以在"个人资料"中上传并更换自己的头像。
2. **AI 好友头像自定义**：用户在创建或编辑 AI 好友（Persona）时，可以上传自定义头像。
3. **图片剪切 (Cropping)**：为了保证 UI 的整齐性（微信风格），所有上传的头像必须经过剪切处理，确保为 1:1 的正方形比例。
4. **外部头像生成器引导**：为降低用户使用门槛，在上传区域旁提供跳转至外部头像生成工具的快捷链接。

---

## 2. 用户故事 (User Stories)

### US-1: 用户个人头像上传
**作为** 一名真实用户，
**我希望** 能在"个人资料"对话框中点击头像并上传本地图片，
**以便于** 在应用中塑造我的数字形象。

### US-2: AI 好友头像上传
**作为** 用户，
**我希望** 在创建/编辑 AI 伙伴时可以自主选择本地图片作为其头像，
**以便于** 让我更清晰地分辨不同的 AI 朋友。

### US-3: 头像剪切与预览
**作为** 用户，
**我希望** 在选择图片后能有一个简单的剪切窗口，让我调整正方形区域，
**以便于** 确保最终头像显示效果完美。

### US-4: 外部头像生成器引导
**作为** 用户，
**我希望** 在头像上传区域旁边看到一个"生成头像"的快捷链接，
**以便于** 我可以快速跳转到外部工具（如 Avataaars）制作个性化卡通头像，无需自己找素材。

---

## 3. 功能范围 (Functional Scope)

### 3.1 后端逻辑 (Backend Support)
- **文件存储服务**：
  - 实现一个通用的图片上传接口 `POST /api/upload/image`。
  - 图片应存储在本地固定目录（如 `server/data/uploads/avatars/`），生产环境下需考虑 Electron 的应用数据目录。
  - 接口返回可访问的相对或绝对 URL。
- **实体关联**：
  - 更新 `profile` 接口，支持保存 `avatar_url`。
  - 更新 `friend/persona` 接口，支持保存并更新 `avatar` 路径。
- **安全性与限制**：
  - 限制文件大小（如 2MB 以内）。
  - 限制文件格式（PNG, JPG, WEBP）。

### 3.2 前端交互 (Frontend Interaction)
- **通用图片选择组件**：
  - 提供隐藏的 `<input type="file">` 触发器。
- **图片剪切插件集成**：
  - 集成 `vue-advanced-cropper` 或类似成熟的 Vue 3 剪切库。
  - **裁剪框限制**：强制锁定 1:1 比例。
  - **UI 风格**：遮罩层效果，符合微信简约风格。
- **组件集成**：
  - `ProfileDialog.vue`: 点击头像区域弹出图片选择 -> 进入剪切 -> 上传并更新。
  - `AssistantWizard.vue` / `FriendEdit.vue`: 同上。
- **外部头像生成器链接**：
  - 在每个头像上传区域旁边，放置一个小型文字链接或图标按钮："创建卡通头像"。
  - 点击后使用 `window.open` 或 `<a target="_blank">` 跳转至 **https://getavataaars.com/**。
  - **设计建议**：链接样式使用弱化色（如灰色小字），避免喧宾夺主，但足够醒目以便用户发现。

---

## 4. 验收标准 (Acceptance Criteria)

- [ ] **AC-1**: 用户点击头像区域能唤起系统文件选择器。
- [ ] **AC-2**: 选择图片后立即弹出剪切层，用户可缩放、移动图片以选取合适区域。
- [ ] **AC-3**: 点击"确定"后，前端应执行裁剪并将结果（Blob/Base64）上传至后端。
- [ ] **AC-4**: 成功上传后，界面上的头像应通过渐变动画更新为新头像。
- [ ] **AC-5**: 用户再次打开应用时，头像应持久化显示，不丢失。
- [ ] **AC-6**: 支持多种常见格式（JPG, PNG, WEBP）。
- [ ] **AC-7**: 头像上传区域旁边应有一个可点击的"创建头像"链接，点击后在新标签页打开 `https://getavataaars.com/`。

---

## 5. 技术依赖与实现参考

- **前端库**: `vue-advanced-cropper` (推荐，性能好且支持 Vue 3)。
- **后端存储**: 
  - 初始阶段：保存到 `server/static/uploads`，通过 FastAPI 的 `StaticFiles` 挂载访问。
  - 生产阶段：确保存储在 `WeAgentChat_DATA_DIR` 路径下，防止更新应用时清空。
- **图像处理**: 后端可使用 `Pillow` 进行二次压缩，确保头像文件不宜过大（建议 200x200 像素）。
- **外链引导**: 无需后端支持，纯前端实现。

---

## 6. 排期建议
- **优先级**: P1 (次高优先级，影响视觉完成度)
- **预估工时**: 1.5d
  - 后端接口与存储: 0.5d
  - 前端剪切组件开发与集成: 0.75d
  - 外链引导 UI: 0.25d (已包含在各组件中)
