# User Story: 头像上传与图片剪切功能 (Avatar Upload & Image Cropping)

## 1. 背景与目标 (Background & Goals)
在 WeAgentChat 中，个性化是社交体验的核心。目前，用户资料和 AI 好友的头像大部分使用默认占位符或硬编码的 URL。
为了提升真实感和品牌美感，我们需要支持：
1. **用户头像自定义**：用户可以在"个人资料"中上传并更换自己的头像。
2. **AI 好友头像自定义**：用户在创建或编辑 AI 好友（Persona）时，可以上传自定义头像。
3. **图片剪切 (Cropping)**：为了保证 UI 的整齐性（微信风格），所有上传的头像必须经过剪切处理，确保为 1:1 的正方形比例。
4. **外部头像生成器引导**：为降低用户使用门槛，在上传区域旁提供跳转至外部头像生成工具的快捷链接。

---

## 2. 用户故事 (User Stories)

### US-1: 用户个人头像上传
**作为** 一名真实用户，
**我希望** 能在"个人资料"对话框中点击头像并上传本地图片，
**以便于** 在应用中塑造我的数字形象。

### US-2: AI 好友头像上传
**作为** 用户，
**我希望** 在创建/编辑 AI 伙伴时可以自主选择本地图片作为其头像，
**以便于** 让我更清晰地分辨不同的 AI 朋友。

### US-3: 头像剪切与预览
**作为** 用户，
**我希望** 在选择图片后能有一个简单的剪切窗口，让我调整正方形区域，
**以便于** 确保最终头像显示效果完美。

### US-4: 外部头像生成器引导
**作为** 用户，
**我希望** 在头像上传区域旁边看到一个"生成头像"的快捷链接，
**以便于** 我可以快速跳转到外部工具（如 Avataaars）制作个性化卡通头像，无需自己找素材。

### US-5: 恢复默认头像
**作为** 用户，
**我希望** 能够删除已设置的自定义头像并恢复到系统的默认占位头像，
**以便于** 在没有合适素材时能快速回退。

---

## 3. 功能范围 (Functional Scope)

### 3.1 数据库与模型变更 (Schema Changes)

#### A. 真实用户头像存储
- **存储位置**：复用现有 `system_settings` 表。
- **配置项**：
  | group_name | key | value (示例) | value_type |
  |------------|-----|--------------|------------|
  | `user` | `avatar` | `/uploads/avatars/user_abc.png` | `string` |
- **优势**：无需新建表或进行数据库迁移，与其他用户设置统一管理。

#### B. AI 好友头像存储
- **`friends` 表**：
  - 新增字段 `avatar`: `String(255)`, 允许为空。存储头像的相对路径或 URL。
  - 需通过 `alembic` 生成迁移脚本。

#### C. 好友库（模板）头像
- **`friend_templates` 表**：
  - 复用现有 `avatar` 字段。
  - **原则**：好友库仅支持内置头像（预设 URL/路径），不支持用户上传。

### 3.2 后端逻辑 (Backend Support)
- **文件存储服务**：
  - 实现一个通用的图片上传接口 `POST /api/upload/image`。
  - 图片应存储在本地固定目录（如 `server/data/uploads/avatars/`）。
  - 返回值包含相对访问路径。
- **静态资源挂载**：
  - 挂载上传目录 `/uploads`。
  - 挂载内置头像目录 `/static/avatars/presets/`（用于存放默认占位符和好友库预设头像）。
- **实体关联与清理**：
  - 扩展 `settings` 相关接口，支持 `user.avatar` 的读写。
  - 更新 `friend` CRUD 接口。
  - **清理逻辑**：当用户上传新头像或删除当前头像时，应考虑删除服务器上过期的冗余旧文件。
- **安全性限制**：
  - 强制限制：文件大小 < 10MB。
  - 格式限制：允许 PNG, JPG, WEBP。

### 3.3 前端交互 (Frontend Interaction)
- **通用图片选择组件**：
  - 具备文件类型（accept="image/*"）和大小的基本前端校验。
- **图片剪切插件集成**：
  - 集成 `vue-advanced-cropper`。
  - 强制 1:1 比例和最小像素（如 200x200）。
- **默认占位逻辑**：
  - 当接口返回头像路径为空时，前端应自动渲染预设的默认图像（用户/AI 各自有一套占位符）。
- **错误处理**：
  - 使用 `Toast` 或全局提示组件反馈上传失败的原因（文件过大、格式错等）。

---

## 4. 验收标准 (Acceptance Criteria)

- [ ] **AC-1**: `friends` 表成功添加 `avatar` 字段（需 alembic 迁移）。
- [ ] **AC-2**: 用户头像成功通过 `system_settings` 表存取（group=`user`, key=`avatar`）。
- [ ] **AC-3**: 用户点击头像区域能唤起文件选择器，且默认只过滤图片格式。
- [ ] **AC-4**: 裁剪层提供实时预览，且强制锁定正方形。
- [ ] **AC-5**: 用户选择超过 2MB 的文件时，系统应弹出明确的错误提示并中止。
- [ ] **AC-6**: 新头像上线后，旧头像对应的旧文件应被自动清理（后端逻辑）。
- [ ] **AC-7**: 未设置头像时，系统能够正确显示默认占位图（不出现裂图）。
- [ ] **AC-8**: 用户提供“重置”或“删除头像”的操作，点击后头像恢复为占位图。
- [ ] **AC-9**: 上传区域旁包含 `https://getavataaars.com/` 的跳转链接。

---

## 5. 技术依赖与实现参考

- **数据库迁移**: 使用 `alembic`。
- **图像库**: 后端 `Pillow` 用于裁剪验证或缩放。
- **前端库**: `vue-advanced-cropper`。
- **存储路径**: 生产环境需适配 `WeAgentChat_DATA_DIR`。

---

## 6. 排期建议
- **优先级**: P1
- **预估工时**: 1.5d
  - 数据库迁移与后端逻辑 (存储、清理、限制): 0.5d
  - 前面剪切组件开发与全场景集成 (含错误处理、占位逻辑): 1.0d
