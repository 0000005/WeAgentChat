# è¢«åŠ¨ä¼šè¯ç®¡ç†ä¸è®°å¿†ç³»ç»Ÿæ•´åˆè®¾è®¡æ–‡æ¡£

## 1. éœ€æ±‚èƒŒæ™¯
åœ¨ WeAgentChat ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æ¨¡æ‹ŸçœŸå®çš„ç¤¾äº¤ä½“éªŒï¼Œå¼±åŒ–â€œäººå·¥å¹²é¢„ï¼ˆå¦‚ï¼šæ–°å»ºä¼šè¯æŒ‰é’®ï¼‰â€ï¼Œå¼ºåŒ–â€œæ—¶é—´æ„Ÿâ€å’Œâ€œè‡ªç„¶è®°å¿†â€ã€‚
å½“ç”¨æˆ·åœæ­¢ä¸ AI èŠå¤©ä¸€æ®µæ—¶é—´åï¼Œæœ¬æ¬¡è¯é¢˜åº”å½“è‡ªç„¶ç»“æŸå¹¶è½¬åŒ–ä¸º AI çš„â€œé•¿æœŸè®°å¿†â€ï¼Œä¸‹æ¬¡èŠå¤©åˆ™æ˜¯åŸºäºè®°å¿†é‡æ–°å¼€å¯çš„æ–°ç¯‡ç« ã€‚

## 2. æ ¸å¿ƒé€»è¾‘ (Product Logic)

### 2.1 è¢«åŠ¨ä¼šè¯ç®¡ç† (Passive Session Management)
- **ä¿ç•™ä½†è‡ªåŠ¨åŒ–**ï¼šä¿ç•™"æ–°å»ºä¼šè¯"æŒ‰é’®ï¼Œä½†è‡ªåŠ¨åŒ–ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå‡å°‘ç”¨æˆ·ä¸»åŠ¨æ“ä½œçš„å¿…è¦æ€§ã€‚
- **æ—¶é—´æ•æ„Ÿç­–ç•¥**ï¼š
    - **ä¼‘çœ é˜¶æ®µ (Idle)**ï¼šå½“ç”¨æˆ·ä¸å¥½å‹çš„æœ€åä¸€æ¬¡äº’åŠ¨è¶…è¿‡ **30 åˆ†é’Ÿ**ï¼ˆé»˜è®¤é…ç½®åï¼š`SESSION_IDLE_THRESHOLD`ï¼‰ã€‚
    - **è‡ªåŠ¨å½’æ¡£ (Auto-Archive)**ï¼šä¸‹ä¸€æ¬¡ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œæˆ–åå°å®šæ—¶ä»»åŠ¡å‘ç°ä¼‘çœ ä¼šè¯æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œâ€œç»“æŸä¼šè¯â€é€»è¾‘ã€‚
    - **æ— æ„Ÿå¼€å¯**ï¼šå¯¹ç”¨æˆ·è€Œè¨€ï¼Œç›´æ¥åœ¨èŠå¤©æ¡†è¾“å…¥å³å¯ï¼Œç³»ç»Ÿåœ¨åå°è‡ªåŠ¨å®Œæˆæ—§ä¼šè¯ç»“ç®—å’Œæ–°ä¼šè¯åˆ›å»ºã€‚

### 2.2 è®°å¿†ç³»ç»Ÿæ•´åˆ (Memory Integration Hook)
- **å½’æ¡£é’©å­**ï¼šåœ¨ä¼šè¯ç»“æŸï¼ˆå½’æ¡£ï¼‰æ—¶ï¼Œè§¦å‘ `on_session_end` é’©å­ã€‚
- **ä¸Šä¸‹æ–‡æå–**ï¼šå°†æœ¬æ¬¡ä¼šè¯çš„æ‰€æœ‰ `Message` è®°å½•æå–å¹¶æ ¼å¼åŒ–ã€‚
- **æ‘˜è¦ç”Ÿæˆ**ï¼š
    - è°ƒç”¨è®°å¿†ç³»ç»Ÿå¯¹åº”çš„ LLM æ¥å£ï¼Œä¸ºæœ¬æ¬¡å¯¹è¯ç”Ÿæˆä¸€ä¸ªç®€çŸ­çš„æ‘˜è¦ï¼ˆä¾‹å¦‚ï¼šâ€œè®¨è®ºäº†å…³äºå‘¨æŠ¥æ’°å†™çš„æ€è·¯â€ï¼‰ã€‚
    - å°†æ‘˜è¦ä½œä¸º Event å­˜å…¥ Memobase ç³»ç»Ÿã€‚
- **æ•°æ®åº“åŒæ­¥**ï¼šæ›´æ–° `chat_sessions` è¡¨ï¼Œå°† `memory_generated` ç½®ä¸º `True`ï¼Œé˜²æ­¢é‡å¤å¤„ç†ã€‚

## 3. æŠ€æœ¯å®ç° (Technical Implementation)

### 3.1 æ•°æ®åº“ç»“æ„

#### A. `chat_sessions` è¡¨æ‰©å±•
å·²åœ¨ `chat_sessions` è¡¨ä¸­å¢åŠ ä»¥ä¸‹å…³é”®å­—æ®µï¼š
- `last_message_time` (DateTime): è®°å½•è¯¥ä¼šè¯æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´ï¼Œç”¨äºåˆ¤å®šæ˜¯å¦è¿‡æœŸã€‚
- `memory_generated` (Boolean): æ ‡è®°è¯¥ä¼šè¯æ˜¯å¦å·²å®Œæˆè®°å¿†å½’æ¡£ã€‚

#### B. `system_settings` è¡¨ï¼ˆæ–°å¢ï¼‰
ç”¨äºç»Ÿä¸€å­˜å‚¨è¿è¡Œæ—¶å¯è°ƒé…ç½®ï¼Œé‡‡ç”¨ **åˆ†ç»„ Key-Value** æ¨¡å¼ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `id` | Integer | ä¸»é”®ï¼Œè‡ªå¢ |
| `group_name` | String(50) | é…ç½®åˆ†ç»„åï¼Œå¦‚ `session`ã€`memory`ã€`notification` |
| `key` | String(100) | é…ç½®é¡¹é”®åï¼Œå¦‚ `passive_timeout` |
| `value` | Text | é…ç½®é¡¹å€¼ï¼ˆå­—ç¬¦ä¸²å­˜å‚¨ï¼Œåº”ç”¨å±‚è´Ÿè´£ç±»å‹è½¬æ¢ï¼‰ |
| `value_type` | String(20) | å€¼ç±»å‹æç¤ºï¼š`int`ã€`bool`ã€`string`ã€`float`ã€`json` |
| `description` | Text | é…ç½®é¡¹æè¿°ï¼ˆå¯é€‰ï¼Œç”¨äºå‰ç«¯å±•ç¤ºï¼‰ |
| `created_at` | DateTime | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DateTime | æœ€åæ›´æ–°æ—¶é—´ |

**å”¯ä¸€çº¦æŸ**ï¼š`(group_name, key)` è”åˆå”¯ä¸€ç´¢å¼•

**åˆå§‹åŒ–æ•°æ®**ï¼ˆé»˜è®¤é…ç½®é¡¹ï¼‰ï¼š

| group_name | key | value | value_type | description |
| :--- | :--- | :--- | :--- | :--- |
| `session` | `passive_timeout` | `1800` | `int` | ä¼šè¯è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ |

### 3.2 åç«¯é€»è¾‘è®¾è®¡

**é…ç½®åŠ è½½**: æ‰€æœ‰è¶…æ—¶å’Œè‡ªåŠ¨è§¦å‘ç›¸å…³çš„å‚æ•°å‡ä»æ•°æ®åº“ `system_settings` è¡¨åŠ¨æ€è¯»å–ï¼Œæ”¯æŒç”¨æˆ·åœ¨å‰ç«¯è®¾ç½®ç•Œé¢å®æ—¶ä¿®æ”¹ã€‚åº”ç”¨å±‚é€šè¿‡ `SettingsService` ç»Ÿä¸€è¯»å–é…ç½®ï¼Œå¹¶æä¾›ç±»å‹è½¬æ¢å’Œé»˜è®¤å€¼å›é€€ã€‚
- `session.passive_timeout`: é»˜è®¤ 1800 ç§’ï¼ˆ30 åˆ†é’Ÿï¼‰

#### A. æ¶ˆæ¯å‘é€æ—¶çš„å‰ç½®æ£€æŸ¥ (`chat_service.py`)
åœ¨ `get_or_create_session_for_friend` å‡½æ•°ä¸­å¢å¼ºé€»è¾‘ï¼š
1. è·å–è¯¥å¥½å‹æœ€è¿‘çš„ä¸€ä¸ªæ´»åŠ¨ä¼šè¯ã€‚
2. åˆ¤å®š `now() - session.last_message_time > THRESHOLD`ã€‚
3. å¦‚æœæ»¡è¶³è¿‡æœŸæ¡ä»¶ï¼š
    - è°ƒç”¨ `archive_session(session_id)` å¤„ç†æ—§å½’æ¡£ã€‚
    - åˆ›å»ºä¸€ä¸ªæ–°çš„ `ChatSession`ã€‚
4. è¿”å›å¯ç”¨çš„ä¼šè¯ IDã€‚

#### B. å¼‚æ­¥å½’æ¡£é€»è¾‘ (`memo_service / chat_service`)
å®ç° `archive_session` å¼‚æ­¥å‡½æ•°ï¼š
1. **è¾¹ç•Œæ£€æŸ¥**ï¼š
   - å¦‚æœä¼šè¯æ¶ˆæ¯æ•° < 2ï¼ˆä»…æœ‰ system æç¤ºæˆ–ç©ºä¼šè¯ï¼‰ï¼Œè·³è¿‡å½’æ¡£ï¼Œç›´æ¥æ ‡è®° `memory_generated = True`ã€‚
   - å¦‚æœ `memory_generated = True`ï¼Œé¿å…é‡å¤å½’æ¡£ã€‚
2. **æå–æ¶ˆæ¯ä¸Šä¸‹æ–‡**ï¼šè·å–è¯¥ä¼šè¯æ‰€æœ‰ `role` ä¸º `user` æˆ– `assistant` çš„æ¶ˆæ¯ã€‚
3. **è°ƒç”¨ Memobase SDK**ï¼š
   - **æ ¸å¿ƒæ¥å£**ï¼š`MemoService.insert_chat(user_id, space_id, messages)`
   - **å‚æ•°æ˜ å°„ï¼ˆæ–¹æ¡ˆ Aï¼šå…¨å±€å…±äº«è®°å¿†ï¼‰**ï¼š
     - `user_id = "default_user"`ï¼šå½“å‰çœŸå®ç”¨æˆ·ï¼ˆå•ç”¨æˆ·æ¨¡å¼ç¡¬ç¼–ç ï¼Œæœªæ¥ä» Session è·å–ï¼‰ã€‚
     - `space_id = "default"`ï¼šå½“å‰ Space IDï¼ˆå¤š Space æœªå®ç°æ—¶ç¡¬ç¼–ç ï¼‰ã€‚
     - `messages`ï¼šOpenAI å…¼å®¹æ ¼å¼çš„æ¶ˆæ¯åˆ—è¡¨ `[{role, content}, ...]`ã€‚
   - **æ·»åŠ å¥½å‹æ ‡ç­¾ï¼ˆé‡è¦ï¼‰**ï¼š
     - é€šè¿‡ `BlobData` çš„ `fields` å‚æ•°ä¼ é€’ metadataï¼š
       ```python
       # In archive_session implementation:
       chat_blob = ChatBlob(messages=messages)
       blob_data = BlobData(
           blob_type=BlobType.chat,
           blob_data=chat_blob.get_blob_data(),
           fields={  # â† Metadata goes here
               "friend_id": str(session.friend_id),
               "friend_name": friend.name,
               "session_id": str(session.id),
               "archived_at": datetime.now().isoformat()
           }
       )
       ```
     - è¿™äº› metadata ä¼šè¢« Memobase ç³»ç»Ÿå­˜å‚¨åœ¨ Event ä¸­ï¼Œæ”¯æŒé€šè¿‡ `fields.friend_id` æ£€ç´¢ç‰¹å®šå¥½å‹çš„è®°å¿†ã€‚
4. **(å¯é€‰) ç«‹å³è§¦å‘æ‘˜è¦ç”Ÿæˆ**ï¼šè°ƒç”¨ `MemoService.trigger_buffer_flush` å¼ºåˆ¶å¤„ç†è¯¥ç”¨æˆ·çš„è®°å¿†ç¼“å†²åŒºã€‚
5. **æ›´æ–°çŠ¶æ€**ï¼š`memory_generated = True`ï¼Œ`update_time = now()`ã€‚
6. **å¼‚å¸¸å¤„ç†**ï¼š
   - å¦‚æœ Memobase è°ƒç”¨å¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ä½†**ä¸é˜»å¡**æ–°ä¼šè¯åˆ›å»ºã€‚
   - ä¿æŒ `memory_generated = False`ï¼Œåç»­ç”±å®šæ—¶ä»»åŠ¡é‡è¯•ã€‚

#### C. å®šæ—¶ä»»åŠ¡ (Background Task)
åœ¨ `app/main.py` çš„ lifespan ä¸­å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡ï¼š
- **æ‰§è¡Œé¢‘ç‡**ï¼šæ¯ 10 åˆ†é’Ÿæ‰«æä¸€æ¬¡ã€‚
- **æ‰«æé€»è¾‘**ï¼š
  ```sql
  SELECT * FROM chat_sessions 
  WHERE memory_generated = False 
    AND deleted = False
    AND last_message_time < NOW() - INTERVAL '30 minutes'
  ```
- **å¤„ç†æ–¹å¼**ï¼šå¯¹æ¯ä¸ªç¬¦åˆæ¡ä»¶çš„ä¼šè¯è°ƒç”¨ `archive_session(session_id)`ã€‚
- **ç›®çš„**ï¼šç¡®ä¿ç”¨æˆ·"èŠå®Œå°±èµ°"çš„åœºæ™¯ä¸‹ï¼Œè®°å¿†ä»èƒ½è‡ªåŠ¨å½’æ¡£ã€‚

#### D. æ‰‹åŠ¨æ–°å»ºä¼šè¯ (`create_session`)
å½“ç”¨æˆ·é€šè¿‡ API æ‰‹åŠ¨è¯·æ±‚åˆ›å»ºæ–°ä¼šè¯æ—¶ï¼š
1. æ£€æŸ¥è¯¥å¥½å‹æ˜¯å¦å­˜åœ¨æœªç»“æŸçš„æ´»è·ƒä¼šè¯ã€‚
2. å¦‚æœå­˜åœ¨ï¼Œç«‹å³è°ƒç”¨ `archive_session(old_session_id)` è¿›è¡Œå½’æ¡£å’Œè®°å¿†ç”Ÿæˆï¼Œæ— è®ºæ—¶é—´æ˜¯å¦è¿‡æœŸã€‚
3. åˆ›å»ºå¹¶è¿”å›æ–°ä¼šè¯ã€‚

## 4. å‰ç«¯äº¤äº’å˜æ›´
- **ä¿ç•™æ‰‹åŠ¨æ§åˆ¶**ï¼š**ä¿ç•™**å·¦ä¾§è¾¹æ æˆ–èŠå¤©å¤´éƒ¨çš„"æ–°å»ºä¼šè¯"æŒ‰é’®ã€‚
    - ç”¨æˆ·ä¿ç•™éšæ—¶æ‰‹åŠ¨å¼€å¯æ–°è¯é¢˜çš„æƒåˆ©ã€‚
    - æ—¢ç„¶æ‰‹åŠ¨å¼€å¯äº†æ–°è¯é¢˜ï¼Œæ„å‘³ç€ç”¨æˆ·ä¸»è§‚ä¸Šè®¤ä¸ºä¸Šä¸€ä¸ªè¯é¢˜å·²ç»ç»“æŸï¼Œå› æ­¤**å¿…é¡»**è§¦å‘ä¸Šä¸€æ¬¡ä¼šè¯çš„è®°å¿†å½’æ¡£ã€‚
- **UI æç¤º - ä¼šè¯è¾¹ç•Œæ—¶é—´æˆ³**ï¼š
    - åœ¨å‘ç”Ÿä¼šè¯åˆ‡æ¢çš„åœ°æ–¹ï¼Œ**æ˜¾ç¤ºä¸€ä¸ªæ—¶é—´æˆ³**ï¼ˆç±»ä¼¼å¾®ä¿¡èŠå¤©è®°å½•ä¸­çš„æ—¶é—´æ˜¾ç¤ºï¼‰ã€‚
    - æ—¶é—´æˆ³æ¥æºï¼šæ–°ä¼šè¯çš„ `create_time` æˆ–ä¸Šä¸€ä¼šè¯çš„ `last_message_time`ã€‚
    - å®ç°æ–¹å¼ï¼šå‰ç«¯éå†æ¶ˆæ¯åˆ—è¡¨æ—¶ï¼Œæ£€æµ‹ `session_id` å˜åŒ–ï¼Œåœ¨è¾¹ç•Œå¤„æ’å…¥æ—¶é—´åˆ†éš”ç»„ä»¶ã€‚
- **æ•°æ®åˆ·æ–°ç­–ç•¥ (å‰ç«¯å¦‚ä½•æ„ŸçŸ¥ä¼šè¯å˜æ›´)**ï¼š
    - **ä¸»åŠ¨åœºæ™¯ï¼ˆç”¨æˆ·åœ¨æ“ä½œæ—¶è§¦å‘ï¼‰**ï¼š
        - *åœºæ™¯æè¿°*ï¼šç”¨æˆ·æ­£åœ¨èŠå¤©çª—å£å‘é€æ¶ˆæ¯æ—¶åˆšå¥½è§¦å‘äº† 30 åˆ†é’Ÿè¶…æ—¶åˆ¤å®šï¼Œæˆ–è€…ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»äº†â€œæ–°å»ºä¼šè¯â€ã€‚
        - *å¤„ç†é€»è¾‘*ï¼šåç«¯ API å“åº”ä¸­ä¼šè¿”å›æ–°çš„ `session_id`ã€‚å‰ç«¯æ£€æµ‹åˆ° ID å˜åŒ–ï¼Œç«‹å³æ›´æ–°æœ¬åœ° stored çš„ä¼šè¯ ID å¹¶é‡æ–°æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ï¼Œä»è€Œè®©ç”¨æˆ·ç«‹åˆ»çœ‹åˆ°ä»£è¡¨æ–°ä¼šè¯å¼€å§‹çš„æ—¶é—´åˆ†éš”çº¿ã€‚
    - **è¢«åŠ¨åœºæ™¯ï¼ˆç”¨æˆ·ä¸åœ¨çº¿ï¼Œåå°è‡ªåŠ¨æ‰§è¡Œï¼‰**ï¼š
        - *åœºæ™¯æè¿°*ï¼šç”¨æˆ·å…³é—­è½¯ä»¶æˆ–ç¦»å¼€ç”µè„‘ 1 å°æ—¶åï¼Œåå°å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å°†è¿‡æœŸä¼šè¯å½’æ¡£ã€‚
        - *å¤„ç†é€»è¾‘*ï¼š**æ— éœ€å®æ—¶æ¨é€**ã€‚å½“ç”¨æˆ·ä¸‹ä¸€æ¬¡æ‰“å¼€è¯¥å¥½å‹çš„èŠå¤©çª—å£æ—¶ï¼Œå‰ç«¯ä¼šç…§å¸¸è°ƒç”¨â€œè·å–å†å²æ¶ˆæ¯â€æ¥å£ï¼Œæ­¤æ—¶è‡ªç„¶ä¼šæ‹‰å–åˆ°æœ€æ–°çš„ä¼šè¯çŠ¶æ€ï¼ˆåŒ…å«åå°å·²ç”Ÿæˆçš„å½’æ¡£çŠ¶æ€ï¼‰ï¼Œç•Œé¢ä¸Šä¼šè‡ªåŠ¨æ˜¾ç¤ºå‡ºæ­£ç¡®çš„æ—¶é—´åˆ†éš”çº¿ã€‚æ­¤å¤„ä¸å¼•å…¥ WebSocket å¤æ‚åº¦ã€‚
- **è®¾ç½®ç•Œé¢å˜æ›´ (`SettingsDialog.vue`)**ï¼š
    - æ–°å¢ **"è®°å¿†è®¾ç½®"** (Memory Settings) ä¾§è¾¹æ é€‰é¡¹å¡ã€‚
    - å¢åŠ å‚æ•°é…ç½®è¡¨å•ï¼š
        - `session.passive_timeout` (Input/Number): ä¼šè¯è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1800ã€‚
    - éœ€é…å¥—å¢åŠ å¯¹åº”çš„å‰ç«¯ Store å’Œåç«¯ API æ¥å£ï¼ˆè°ƒç”¨ `system_settings` ç›¸å…³ APIï¼‰ã€‚

## 5. è¾¹ç•Œæƒ…å†µä¸æ³¨æ„äº‹é¡¹
1. **ç©ºä¼šè¯è¿‡æ»¤**ï¼šæ¶ˆæ¯æ•° < 2 çš„ä¼šè¯ä¸ç”Ÿæˆè®°å¿†ï¼Œä»…æ ‡è®°ä¸ºå·²å¤„ç†ã€‚
2. **å¹¶å‘æ§åˆ¶**ï¼šå½’æ¡£è¿‡ç¨‹ä½¿ç”¨ `memory_generated` å­—æ®µé˜²æ­¢é‡å¤å¤„ç†ã€‚
3. **å¤±è´¥é‡è¯•**ï¼šå½’æ¡£å¤±è´¥ä¸é˜»å¡ç”¨æˆ·ä½“éªŒï¼Œç”±å®šæ—¶ä»»åŠ¡è‡ªåŠ¨é‡è¯•ã€‚
4. **è®°å¿†å…±äº«ç­–ç•¥ï¼ˆæ–¹æ¡ˆ Aï¼‰**ï¼š
   - æ‰€æœ‰ AI å¥½å‹å…±äº«åŒä¸€ä¸ªçœŸå®ç”¨æˆ·çš„è®°å¿†åº“ï¼ˆ`user_id = "default_user"`ï¼‰ã€‚
   - æ¯æ¡è®°å¿†äº‹ä»¶å¿…é¡»é€šè¿‡ `metadata.friend_id` æ ‡è®°æ¥æºå¥½å‹ã€‚
   - æœªæ¥å¯é€šè¿‡æ ‡ç­¾å®ç°"ä»…æ£€ç´¢ä¸ç‰¹å®šå¥½å‹ç›¸å…³çš„è®°å¿†"ã€‚
5. **å¤šç”¨æˆ·/å¤š Space å‡†å¤‡**ï¼š
   - å½“å‰ `user_id` å’Œ `space_id` ä½¿ç”¨ç¡¬ç¼–ç ï¼Œæœªæ¥éœ€æ”¹ä¸ºä» Session/Context è·å–ã€‚
   - å¤š Space åœºæ™¯ä¸‹ï¼Œä¸åŒ Space çš„è®°å¿†éœ€å®Œå…¨éš”ç¦»ï¼ˆå¦‚"èŒåœº"Space ä¸"å¤ä»£å®«å»·"Spaceï¼‰ã€‚

## 6. é…ç½®å‚æ•°

é…ç½®é¡¹å­˜å‚¨äº `system_settings` è¡¨ï¼Œé‡‡ç”¨ `group_name.key` å‘½åè§„èŒƒï¼š

| group_name | key | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- |
| `session` | `passive_timeout` | `1800` (ç§’) | ä¼šè¯åˆ¤å®šè¿‡æœŸçš„éæ´»è·ƒæ—¶é•¿ (30åˆ†é’Ÿ) |

---

## 7. å¼€å‘è¿›åº¦ (Development Progress)

> æœ€åæ›´æ–°ï¼š2026-01-05

### âœ… å·²å®Œæˆ

| æ¨¡å— | åŠŸèƒ½ | ç›¸å…³æ–‡ä»¶ | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| **æ•°æ®åº“** | `chat_sessions` è¡¨æ‰©å±• (`memory_generated`, `last_message_time`) | `server/app/models/chat.py` | è¿ç§» `7fa2b40a0479` |
| **æ•°æ®åº“** | `system_settings` è¡¨ (åˆ†ç»„ KV é…ç½®å­˜å‚¨) | `server/app/models/system_setting.py` | è¿ç§» `0a8be336eb20` |
| **åç«¯æœåŠ¡** | `SettingsService` (é…ç½®è¯»å†™ã€ç±»å‹è½¬æ¢ã€é»˜è®¤å€¼åˆå§‹åŒ–) | `server/app/services/settings_service.py` | æ”¯æŒ int/bool/float/json/string |
| **åç«¯ API** | `/api/settings/{group_name}` (åˆ†ç»„æŸ¥è¯¢/æ‰¹é‡æ›´æ–°) | `server/app/api/endpoints/settings.py` | RESTful è®¾è®¡ |
| **åç«¯ API** | `/api/settings/{group_name}/{key}` (å•é¡¹æŸ¥è¯¢/æ›´æ–°) | `server/app/api/endpoints/settings.py` | PUT ä½¿ç”¨ Request Body |
| **ä¸šåŠ¡é€»è¾‘** | è¢«åŠ¨ä¼šè¯è¶…æ—¶åˆ¤å®š (`get_or_create_session_for_friend`) | `server/app/services/chat_service.py` | è¯»å– `session.passive_timeout` |
| **ä¸šåŠ¡é€»è¾‘** | `archive_session` å‡½æ•° (è¾¹ç•Œæ£€æŸ¥ + æ ‡è®°) | `server/app/services/chat_service.py` | æ¶ˆæ¯æ•° < 2 è·³è¿‡ |
| **æ•°æ®åº“è¿ç§»** | ç´¢å¼•çŠ¶æ€ä¸€è‡´æ€§ä¿®å¤ | `server/alembic/versions/fix_001_*.py` | å¹‚ç­‰å¤„ç† |

### ğŸš§ è¿›è¡Œä¸­ / å¾…å¼€å‘

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| **åç«¯ - è®°å¿†é›†æˆ** | `archive_session` è°ƒç”¨ Memobase SDK æå–æ‘˜è¦ | ğŸ”´ é«˜ | å½“å‰ä»…åšæ ‡è®°ï¼ŒTODO å®ç° |
| **åç«¯ - å®šæ—¶ä»»åŠ¡** | å‘¨æœŸæ€§æ‰«æè¿‡æœŸä¼šè¯å¹¶å½’æ¡£ | ğŸŸ¡ ä¸­ | åœ¨ `main.py` lifespan ä¸­å®ç° |
| **åç«¯ - æ‰‹åŠ¨æ–°å»ºä¼šè¯** | æ–°å»ºä¼šè¯æ—¶å¼ºåˆ¶å½’æ¡£æ—§ä¼šè¯ | ğŸŸ¡ ä¸­ | éœ€æ›´æ–° `create_session` é€»è¾‘ |
| **å‰ç«¯ - è®¾ç½®ç•Œé¢** | "è®°å¿†è®¾ç½®" é€‰é¡¹å¡ (`SettingsDialog.vue`) | ğŸŸ¡ ä¸­ | è°ƒç”¨ `/api/settings` API |
| **å‰ç«¯ - ä¼šè¯è¾¹ç•Œ** | æ—¶é—´æˆ³åˆ†éš”çº¿ (æ£€æµ‹ `session_id` å˜åŒ–) | ğŸŸ¢ ä½ | UI å±‚é¢ |

### ğŸ“ ç›¸å…³æ–‡ä»¶ç´¢å¼•

```
server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/endpoints/
â”‚   â”‚   â””â”€â”€ settings.py          # é…ç½® API
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ chat.py              # ChatSession, Message
â”‚   â”‚   â””â”€â”€ system_setting.py    # SystemSetting
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ chat_service.py      # è¢«åŠ¨ä¼šè¯é€»è¾‘
â”‚   â”‚   â””â”€â”€ settings_service.py  # é…ç½®æœåŠ¡
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ init_db.py           # å¯åŠ¨æ—¶åˆå§‹åŒ–é»˜è®¤é…ç½®
â””â”€â”€ alembic/versions/
    â”œâ”€â”€ 7fa2b40a0479_*.py        # chat_sessions æ‰©å±•
    â”œâ”€â”€ 0a8be336eb20_*.py        # system_settings è¡¨
    â””â”€â”€ fix_001_*.py             # ç´¢å¼•ä¿®å¤
```
